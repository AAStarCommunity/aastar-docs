import{_ as s,c as e,o as i,ag as a}from"./chunks/framework.dvv-DFtf.js";const c=JSON.parse('{"title":"L3 Lifecycle API Developer Guide","description":"","frontmatter":{},"headers":[],"relativePath":"guide/docs/L3_Lifecycle_Developer_Guide.md","filePath":"guide/docs/L3_Lifecycle_Developer_Guide.md","lastUpdated":null}'),l={name:"guide/docs/L3_Lifecycle_Developer_Guide.md"};function n(d,t,r,h,o,p){return i(),e("div",null,[...t[0]||(t[0]=[a(`<h1 id="l3-lifecycle-api-developer-guide" tabindex="-1">L3 Lifecycle API Developer Guide <a class="header-anchor" href="#l3-lifecycle-api-developer-guide" aria-label="Permalink to &quot;L3 Lifecycle API Developer Guide&quot;">​</a></h1><p>本文档旨在帮助开发者理解和使用 <code>@aastar/sdk</code> 提供的 L3 Lifecycle API。这些 API 封装了 L1/L2 的底层交互，提供了面向角色的全生命周期管理能力。</p><h2 id="_1-核心类概览" tabindex="-1">1. 核心类概览 <a class="header-anchor" href="#_1-核心类概览" aria-label="Permalink to &quot;1. 核心类概览&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">角色 (Role)</th><th style="text-align:left;">对应类 (Class)</th><th style="text-align:left;">包 (Package)</th><th style="text-align:left;">职责描述</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>Operator</strong></td><td style="text-align:left;"><code>OperatorLifecycle</code></td><td style="text-align:left;"><code>@aastar/operator</code></td><td style="text-align:left;">管理 SuperPaymaster 节点运营者，包括质押、入驻、配置、资金管理和退出。</td></tr><tr><td style="text-align:left;"><strong>End User</strong></td><td style="text-align:left;"><code>UserLifecycle</code></td><td style="text-align:left;"><code>@aastar/enduser</code></td><td style="text-align:left;">管理终端用户，包括加入社区 (Onboard)、发送 Gasless 交易、以及退出社区。</td></tr><tr><td style="text-align:left;"><strong>Admin</strong></td><td style="text-align:left;"><code>ProtocolGovernance</code></td><td style="text-align:left;"><code>@aastar/admin</code></td><td style="text-align:left;">(DAO/Admin) 管理协议全局参数、拥有权转移等治理操作。</td></tr></tbody></table><hr><h2 id="_2-operator-lifecycle-运营者" tabindex="-1">2. Operator Lifecycle (运营者) <a class="header-anchor" href="#_2-operator-lifecycle-运营者" aria-label="Permalink to &quot;2. Operator Lifecycle (运营者)&quot;">​</a></h2><p><strong>类名</strong>: <code>OperatorLifecycle</code><strong>前提</strong>: 账户需持有足够的 GToken，并已被授权基础社区身份 (<code>ROLE_COMMUNITY</code>, 通常由 DAO 投票决定)。</p><table tabindex="0"><thead><tr><th style="text-align:left;">阶段 (Phase)</th><th style="text-align:left;">动作 (Action API)</th><th style="text-align:left;">主要参数</th><th style="text-align:left;">进入前状态 (Pre-State)</th><th style="text-align:left;">行动后状态 (Post-State)</th><th style="text-align:left;">备注 (Notes)</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>Setup</strong></td><td style="text-align:left;"><code>setupNode()</code></td><td style="text-align:left;"><code>type: &#39;SUPER&#39;</code><br><code>stakeAmount</code><br><code>depositAmount</code></td><td style="text-align:left;">- 持有 GToken<br>- 有 <code>ROLE_COMMUNITY</code></td><td style="text-align:left;">- 获得 <code>ROLE_PAYMASTER_SUPER</code><br>- Registry: GToken 被质押<br>- Paymaster: 存入初始 Collateral</td><td style="text-align:left;">一键完成 <code>Approve</code> + <code>RegisterRole</code> + <code>Deposit</code>。</td></tr><tr><td style="text-align:left;"><strong>Operate</strong></td><td style="text-align:left;"><code>depositCollateral()</code></td><td style="text-align:left;"><code>amount</code></td><td style="text-align:left;">- 节点运行中<br>- Collateral 余额不足</td><td style="text-align:left;">- Paymaster: Collateral 增加</td><td style="text-align:left;">用于补充 Gas 代付备用金。</td></tr><tr><td style="text-align:left;"><strong>Operate</strong></td><td style="text-align:left;"><code>withdrawCollateral()</code></td><td style="text-align:left;"><code>amount</code></td><td style="text-align:left;">- Paymaster 有余额</td><td style="text-align:left;">- Paymaster: Collateral 减少<br>- 钱包收到退回的 GToken</td><td style="text-align:left;">随时可提，无锁定期 (除非涉及 ETH Stake)。</td></tr><tr><td style="text-align:left;"><strong>Query</strong></td><td style="text-align:left;"><code>checkReadiness()</code></td><td style="text-align:left;">-</td><td style="text-align:left;">-</td><td style="text-align:left;">返回 <code>{ isConfigured, isActive, balance }</code></td><td style="text-align:left;">检查节点是否配置完成及当前余额。</td></tr><tr><td style="text-align:left;"><strong>Exit</strong></td><td style="text-align:left;"><code>withdrawAllFunds()</code></td><td style="text-align:left;"><code>to</code> (可选)</td><td style="text-align:left;">- 节点运行中<br>- 有质押和存款</td><td style="text-align:left;">- Paymaster: Collateral 清零<br>- Registry: <strong>触发退出锁定期</strong> (如30天)</td><td style="text-align:left;"><strong>注意</strong>: 如果 Role 有锁定期 (如30天)，此调用会触发 <code>exitRole</code> 并<strong>Revert</strong> (或进入冷却期)，资金需等待期满后方可完全提取。</td></tr></tbody></table><h3 id="开发者示例" tabindex="-1">开发者示例 <a class="header-anchor" href="#开发者示例" aria-label="Permalink to &quot;开发者示例&quot;">​</a></h3><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { OperatorLifecycle } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@aastar/sdk&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 初始化</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> operator</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OperatorLifecycle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    client: walletClient, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">contracts </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1. 入驻 (需先获得 ROLE_COMMUNITY)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> operator.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setupNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;SUPER&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stakeAmount: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseEther</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;50&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 质押 50 GT 到 Registry</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    depositAmount: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseEther</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;10&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 存入 10 GT 到 Paymaster 用于付 Gas</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 2. 退出</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 注意：如果 Registry 设置了 roleLockDuration，这步在锁定期内会失败</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> operator.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">withdrawAllFunds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Exit initiated or locked:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, e.message);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="_3-user-lifecycle-终端用户" tabindex="-1">3. User Lifecycle (终端用户) <a class="header-anchor" href="#_3-user-lifecycle-终端用户" aria-label="Permalink to &quot;3. User Lifecycle (终端用户)&quot;">​</a></h2><p><strong>类名</strong>: <code>UserLifecycle</code><strong>前提</strong>: 这是一个抽象层，既支持 EOA 也支持 AA 账户。</p><table tabindex="0"><thead><tr><th style="text-align:left;">阶段 (Phase)</th><th style="text-align:left;">动作 (Action API)</th><th style="text-align:left;">主要参数</th><th style="text-align:left;">进入前状态 (Pre-State)</th><th style="text-align:left;">行动后状态 (Post-State)</th><th style="text-align:left;">备注 (Notes)</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>Onboard</strong></td><td style="text-align:left;"><code>onboard()</code></td><td style="text-align:left;"><code>community</code> (Address)<br><code>stakeAmount</code></td><td style="text-align:left;">- 持有 GToken (用于质押)<br>- <strong>未</strong>加入该社区</td><td style="text-align:left;">- 获得 <code>ROLE_ENDUSER</code><br>- Mint 该社区的 SBT<br>- Registry: GToken 被质押</td><td style="text-align:left;">类似于 &quot;注册/会员&quot; 流程。</td></tr><tr><td style="text-align:left;"><strong>Verify</strong></td><td style="text-align:left;"><code>checkEligibility()</code></td><td style="text-align:left;"><code>community</code></td><td style="text-align:left;">-</td><td style="text-align:left;">返回 <code>boolean</code></td><td style="text-align:left;">检查是否满足加入条件 (如黑名单检查)。</td></tr><tr><td style="text-align:left;"><strong>Operate</strong></td><td style="text-align:left;"><code>enableGasless()</code></td><td style="text-align:left;"><code>config: { policy }</code></td><td style="text-align:left;">-</td><td style="text-align:left;">- 本地配置已更新</td><td style="text-align:left;">开启 Gasless 模式开关。</td></tr><tr><td style="text-align:left;"><strong>Operate</strong></td><td style="text-align:left;"><code>executeGaslessTx()</code></td><td style="text-align:left;"><code>target</code><br><code>data</code><br><code>value</code></td><td style="text-align:left;">- 已 Onboard<br>- 有足够 Reputation/Credit</td><td style="text-align:left;">- 交易成功上链<br>- 消耗 Credit 而非 ETH</td><td style="text-align:left;">会自动路由到对应的 Paymaster (V4 或 Super)。</td></tr><tr><td style="text-align:left;"><strong>Query</strong></td><td style="text-align:left;"><code>getMyReputation()</code></td><td style="text-align:left;">-</td><td style="text-align:left;">-</td><td style="text-align:left;">返回 <code>{ score, creditLimit }</code></td><td style="text-align:left;">查询当前信誉分和可用额度。</td></tr><tr><td style="text-align:left;"><strong>Exit</strong></td><td style="text-align:left;"><code>leaveCommunity()</code></td><td style="text-align:left;"><code>community</code></td><td style="text-align:left;">- 已加入社区<br>- 持有 SBT</td><td style="text-align:left;">- SBT 被销毁<br>- 角色移除</td><td style="text-align:left;">退出社区，不再享受该社区的权益/Sponsorship。</td></tr></tbody></table><h3 id="开发者示例-1" tabindex="-1">开发者示例 <a class="header-anchor" href="#开发者示例-1" aria-label="Permalink to &quot;开发者示例&quot;">​</a></h3><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { UserLifecycle } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@aastar/sdk&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1. 加入社区</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserLifecycle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> canJoin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkEligibility</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(communityAddr);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (canJoin) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onboard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(communityAddr, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseEther</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0.4&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 质押 0.4 GT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 2. 发送 Gasless 交易</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enableGasless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ policy: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;CREDIT&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> txHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">executeGaslessTx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    target: targetContract,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encodeFunctionData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><hr><h2 id="_4-admin-protocol-governance" tabindex="-1">4. Admin (Protocol Governance) <a class="header-anchor" href="#_4-admin-protocol-governance" aria-label="Permalink to &quot;4. Admin (Protocol Governance)&quot;">​</a></h2><p><strong>类名</strong>: <code>ProtocolGovernance</code><strong>前提</strong>: 调用者需是 Registry 或各个核心合约的 Owner。</p><table tabindex="0"><thead><tr><th style="text-align:left;">动作 (Action API)</th><th style="text-align:left;">描述</th><th style="text-align:left;">涉及合约</th></tr></thead><tbody><tr><td style="text-align:left;"><code>transferDAO(newDAO)</code></td><td style="text-align:left;">将所有核心合约的 Owner 权限转移给新的 DAO 地址。</td><td style="text-align:left;">Registry, SuperPaymaster, etc.</td></tr><tr><td style="text-align:left;"><code>updateGlobalParams()</code></td><td style="text-align:left;">更新全局参数 (如 ProtocolFee, Treasury)。</td><td style="text-align:left;">Registry</td></tr><tr><td style="text-align:left;"><code>upgradeContracts()</code></td><td style="text-align:left;">升级核心合约实现 (TBD)。</td><td style="text-align:left;">Factory, Registry</td></tr></tbody></table><hr><h2 id="_5-常见问题-faq" tabindex="-1">5. 常见问题 (FAQ) <a class="header-anchor" href="#_5-常见问题-faq" aria-label="Permalink to &quot;5. 常见问题 (FAQ)&quot;">​</a></h2><h3 id="q-为什么-withdrawallfunds-会失败" tabindex="-1">Q: 为什么 <code>withdrawAllFunds</code> 会失败? <a class="header-anchor" href="#q-为什么-withdrawallfunds-会失败" aria-label="Permalink to &quot;Q: 为什么 \`withdrawAllFunds\` 会失败?&quot;">​</a></h3><p><strong>A</strong>: 在 Aastar 协议设计中，为了防止恶意节点作恶后立即跑路，核心角色 (如 <code>ROLE_PAYMASTER_SUPER</code>) 通常设有 <strong>退出锁定期 (Role Lock Duration)</strong>，例如 30 天。 在此期间，如果您尝试调用 <code>exitRole</code> (包含在 <code>withdrawAllFunds</code> 中)，Registry 合约会拒绝该操作。您必须保持节点在线直到服务期满，或等待锁定期结束。</p><h3 id="q-userlifecycle-支持-aa-吗" tabindex="-1">Q: <code>UserLifecycle</code> 支持 AA 吗? <a class="header-anchor" href="#q-userlifecycle-支持-aa-吗" aria-label="Permalink to &quot;Q: \`UserLifecycle\` 支持 AA 吗?&quot;">​</a></h3><p><strong>A</strong>: 是的。初始化 <code>UserLifecycle</code> 时传入 <code>accountAddress</code> (AA 地址) 和 <code>client</code> (具备签名能力的 Client)。如果是 Gasless 交易，SDK 会自动构建 UserOperation 并发送给 Bundler；如果是普通交易，则直接通过 Client 发送。</p>`,26)])])}const g=s(l,[["render",n]]);export{c as __pageData,g as default};
